name: 构建 HK1 Box (S905X3) OpenWrt

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: 'OpenWrt 版本 (由于架构限制，请务必选 24.10.0 或 SNAPSHOT)'
        required: true
        default: '24.10.0'
        type: choice
        options:
          - '24.10.0'
          - 'SNAPSHOT'
      lan_ip:
        description: '路由器管理地址 (LAN IP)'
        required: true
        default: '192.168.1.1'
      enable_docker:
        description: '是否安装 Docker'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 初始化环境
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev zlib1g-dev gawk git gettext \
          libssl-dev xsltproc rsync wget unzip python3 python3-setuptools python3-pyelftools zstd

      - name: 下载 Image Builder
        run: |
          VERSION="${{ github.event.inputs.luci_version }}"
          
          # 24.10及以上版本统统使用 zst 格式
          FILE_EXT="tar.zst"

          if [ "$VERSION" == "SNAPSHOT" ]; then
             IB_URL="https://downloads.openwrt.org/snapshots/targets/amlogic/meson/openwrt-imagebuilder-amlogic-meson.Linux-x86_64.${FILE_EXT}"
          else
             # 24.10.0 是目前唯一的稳定版选择
             IB_URL="https://downloads.openwrt.org/releases/${VERSION}/targets/amlogic/meson/openwrt-imagebuilder-${VERSION}-amlogic-meson.Linux-x86_64.${FILE_EXT}"
          fi
          
          echo "正在尝试下载: $IB_URL"
          
          # 检查地址是否有效
          if ! wget --spider -q "$IB_URL"; then
             echo "::error::下载失败！官方服务器上找不到版本: $VERSION 的 amlogic 镜像。"
             echo "::error::请尝试在手动触发时输入 '24.10.0' 或 'SNAPSHOT'。"
             exit 1
          fi

          mkdir -p openwrt-ib
          wget -qO- "$IB_URL" | tar -I zstd -xf - -C openwrt-ib --strip-components=1

      - name: 配置系统参数
        working-directory: ./openwrt-ib
        run: |
          mkdir -p files/etc/uci-defaults
          cat <<EOF > files/etc/uci-defaults/99-custom-settings
          #!/bin/sh
          uci set network.lan.ipaddr='${{ github.event.inputs.lan_ip }}'
          uci commit network
          sed -i 's/option check_signature/# option check_signature/g' /etc/opkg.conf
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-custom-settings

          # 基础包
          PACKAGES="luci luci-base luci-ssl uhttpd uhttpd-mod-ubus \
          luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn \
          luci-app-ttyd luci-i18n-ttyd-zh-cn \
          bash curl wget-ssl tar unzip lsblk fdisk e2fsprogs \
          kmod-fs-ext4 kmod-fs-vfat kmod-fs-exfat kmod-usb-storage kmod-usb-storage-uas"

          if [ "${{ github.event.inputs.enable_docker }}" == "true" ]; then
             PACKAGES="$PACKAGES docker docker-compose luci-app-dockerman luci-i18n-dockerman-zh-cn"
          fi
          
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: 生成 Rootfs
        working-directory: ./openwrt-ib
        run: |
          make image PROFILE="generic" PACKAGES="$PACKAGES" FILES="files"
          mkdir -p ../ready_to_pack
          cp bin/targets/amlogic/meson/*.tar.gz ../ready_to_pack/rootfs.tar.gz

      - name: 封装为盒子启动镜像 (Ophub 打包)
        uses: ophub/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ready_to_pack/rootfs.tar.gz
          openwrt_board: hk1box
          openwrt_kernel: 6.6.y
          auto_generate_kernel: v6.6.y

      - name: 整理并上传产物
        run: |
          mkdir -p firmware
          find out/ -name "*.img.gz" -exec mv {} firmware/ \;
          cd firmware
          for f in *.img.gz; do 
            mv "$f" "OpenWrt_${{ github.event.inputs.luci_version }}_HK1Box_S905X3.img.gz"
          done

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: HK1Box-OpenWrt-Image
          path: firmware/*
